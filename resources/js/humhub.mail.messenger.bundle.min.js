humhub.module("mail.ConversationView",function(r,t,o){var s=t("ui.widget").Widget,a=t("ui.loader"),c=t("client"),n=t("ui.additions"),e=t("util.object"),i=t("mail.notification"),l=s.extend();l.prototype.init=function(){n.observe(this.$);var e=this;window.onresize=function(t){e.updateSize()},this.getActiveMessageId()||this.setActiveMessageId(s.instance("#inbox").getFirstMessageId()),this.reload(),this.$.on("mouseenter",".mail-conversation-entry",function(){o(this).find(".conversation-menu").fadeIn("fast")}).on("mouseleave",".mail-conversation-entry",function(){o(this).find(".conversation-menu").hide()})},l.prototype.loader=function(t){!1!==t?a.set(this.$):a.reset(this.$)},l.prototype.markSeen=function(t){c.post(this.options.markSeenUrl,{data:{id:t}}).then(function(t){e.isDefined(t.messageCount)&&i.setMailMessageCount(t.messageCount)}).catch(function(t){r.log.error(t)})},l.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:last").data("entry-id"),e={id:this.getActiveMessageId(),from:t},n=this;c.get(this.options.loadUpdateUrl,{data:e}).then(function(t){t.html&&o(t.html).each(function(){n.appendEntry(o(this))})})},l.prototype.reply=function(t){var e=this;c.submit(t).then(function(t){t.success?(e.appendEntry(t.content),e.$.find(".time").timeago(),s.instance(o("#replyform-message").trigger("clear")).focus(),e.focus()):r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},l.prototype.focus=function(t){s.instance("#replyform-message").focus()},l.prototype.canLoadMore=function(){return!0},l.prototype.reload=function(){this.getActiveMessageId()&&this.loadMessage(this.getActiveMessageId())},l.prototype.addUser=function(t){var e=this;c.submit(t).then(function(t){t.result?e.$.find("#mail-conversation-header").html(t.result):t.error&&r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},l.prototype.appendEntry=function(t){var e,n=this,i=o(t);n.$.find('[data-entry-id="'+i.data("entryId")+'"]').length||((e=i.not("script, link").filter(function(){return 1===this.nodeType})).css("opacity",0),this.getListNode().append(i),e.hide().css("opacity",1).fadeIn("fast",function(){n.scrollToBottom(),n.onUpdate()}))},l.prototype.loadMessage=function(n){var i=e.isNumber(n)?n:n.$trigger.data("message-id"),o=this;this.loader(),c.get(this.options.loadMessageUrl,{data:{id:i}}).then(function(t){var e;return o.setActiveMessageId(i),o.options.isLast=!1,s.instance("#inbox").updateActiveItem(),n.$trigger&&history&&history.replaceState&&((e=n.$trigger.data("action-url"))&&history.replaceState(null,null,e)),o.$.css("visibility","hidden"),o.updateContent(t.html)}).then(function(){return o.initScroll()}).catch(function(t){r.log.error(t,!0)}).finally(function(){o.loader(!1),o.$.css("visibility","visible"),o.initReplyRichText()})},l.prototype.initReplyRichText=function(){this.focus(),o("#replyform-message").on("keyup",function(t){13===t.which&&window.scrollTo(0,document.body.scrollHeight)})},l.prototype.initScroll=function(){if(window.IntersectionObserver){var e=this.$.find(".conversation-entry-list"),t=o('<div class="stream-end"></div>');e.prepend(t);var n=this,i=new IntersectionObserver(function(t){n.preventScrollLoading()||t.length&&t[0].isIntersecting&&(a.prepend(e),n.loadMore().finally(function(){a.reset(e)}))},{root:e[0],rootMargin:"50px"});return this.assureScroll().then(function(){i.observe(t[0]),n.getListNode().niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}})})}},l.prototype.loadMore=function(){var n=this,t={id:this.getActiveMessageId(),from:this.$.find(".mail-conversation-entry:first").data("entryId")};return c.get(this.options.loadMoreUrl,{data:t}).then(function(t){var e;t.result&&(e=o(t.result).hide(),n.$.find(".conversation-entry-list").find(".stream-end").after(e),e.fadeIn()),n.options.isLast=!t.result||t.isLast}).catch(function(t){r.log.error(t,!0)})},l.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},l.prototype.canLoadMore=function(){return!this.options.isLast},l.prototype.assureScroll=function(){var t=this,e=this.$.find(".conversation-entry-list");return e[0].offsetHeight>=e[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):t.scrollToBottom()},l.prototype.updateContent=function(e){var n=this;return new Promise(function(t){n.$.html(e),t()})},l.prototype.getActiveMessageId=function(){return this.options.messageId},l.prototype.setActiveMessageId=function(t){this.options.messageId=t},l.prototype.scrollToBottom=function(){var n=this;return new Promise(function(t){var e=n.getListNode();n.updateSize().then(function(){e[0].scrollTop=e[0].scrollHeight,t()})})},l.prototype.updateSize=function(){var i=this;return new Promise(function(n){setTimeout(function(){var t,e;o(".conversation-entry-list").length&&(t=o(".mail-message-form").height(),e=window.innerHeight-i.$.position().top-t-160+"px",i.$.find(".conversation-entry-list").css("max-height",e),n())},100)})},l.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},l.prototype.onUpdate=function(){this.getListNode().getNiceScroll().resize()},r.export=l}),humhub.module("mail.ConversationEntry",function(t,e,i){var n=e("ui.widget").Widget.extend();n.prototype.replace=function(t){var e=this,n=i(t).hide();this.$.fadeOut(function(){i(this).replaceWith(n),e.$=n,e.$.fadeIn("slow")})},n.prototype.remove=function(){this.$.fadeToggle("slow",function(){i(this).remove()})},t.export=n}),humhub.module("mail.inbox",function(o,t,r){var n=t("ui.widget").Widget,e=t("ui.filter").Filter,i=t("ui.view"),s=t("ui.loader"),a=t("client"),c=e.extend();c.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},c.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),n=e.find(".filterCount");t?(n.length||(n=r('<small class="filterCount"></small>').insertBefore(e.find(".caret"))),n.html(" <b>("+t+")</b> ")):n.length&&n.remove()};var l=n.extend();l.prototype.init=function(){this.filter=n.instance("#mail-filter-root"),this.initScroll();var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",function(){t.reload().then(function(){t.updateActiveItem()})}),i.isLarge()&&this.$.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:3,left:0,bottom:0}})},l.prototype.initScroll=function(){var t,e,n;window.IntersectionObserver&&(t=r('<div class="stream-end"></div>'),this.$.append(t),e=this,n=new IntersectionObserver(function(t){e.preventScrollLoading()||t.length&&t[0].isIntersecting&&(s.append(e.$),e.loadMore().finally(function(){s.reset(e.$)}))},{root:this.$[0],rootMargin:"50px"}),this.assureScroll().then(function(){n.observe(t[0])}))},l.prototype.assureScroll=function(){var t=this;return this.$[0].offsetHeight>=this.$[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()}):Promise.resolve()},l.prototype.loadMore=function(){var i=this;return new Promise(function(e,n){var t=i.filter.getFilterMap();t.from=i.getLastMessageId(),a.get(i.options.loadMoreUrl,{data:t}).then(function(t){t.result&&(r(t.result).insertBefore(".stream-end"),i.$.find(".stream-end").append()),i.options.isLast=!t.result||t.isLast,i.updateActiveItem(),e()}).catch(function(t){o.log.error(t,!0),n()}).finally(function(){i.scrollLock=!1})})},l.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},l.prototype.canLoadMore=function(){return!this.options.isLast},l.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}},l.prototype.updateActiveItem=function(){var t=n.instance("#mail-conversation-root").getActiveMessageId();this.$.find(".entry").removeClass("selected"),this.$.find(".entry.selected").find(".new-message-badge").hide(),this.$.find(".entry").removeClass("selected");var e=this.$.find('[data-message-preview="'+t+'"]');e.length&&e.addClass("selected").find(".new-message-badge").hide()},l.prototype.getFirstMessageId=function(){return this.$.find(".entry:first").data("messagePreview")},l.prototype.getLastMessageId=function(){return this.$.find(".entry:last").data("messagePreview")};o.export({ConversationList:l,Filter:c,setTagFilter:function(t){r("#mail-filter-menu").collapse("show"),n.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])}})}),humhub.module("mail.conversation",function(i,t,e){var r=t("ui.widget").Widget,o=t("ui.modal"),n=t("client"),s=t("event"),a=t("mail.notification"),c=function(t){return r.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')},l=function(t){return e("#mail-conversation-overview").find('[data-message-preview="'+t+'"]')};i.export({init:function(){s.on("humhub:modules:mail:live:NewUserMessage",function(t,e,n){var i=r.instance("#mail-conversation-root"),o=!1;e.forEach(function(t){!o&&i&&i.options.messageId==t.data.message_id?(i.loadUpdate(),o=!0,i.markSeen(t.data.message_id)):i&&l(t.data.message_id).find(".new-message-badge").show(),a.setMailMessageCount(t.data.count)})}).on("humhub:modules:mail:live:UserMessageDeleted",function(t,e,n){e.forEach(function(t){var e=c(t.data.entry_id);e&&e.remove(),a.setMailMessageCount(t.data.count)})})},leave:function(t){n.post(t).then(function(t){t.redirect&&n.pjax.redirect(t.redirect)}).catch(function(t){i.log.error(t,!0)})},submitEditEntry:function(n){o.submit(n).then(function(t){var e;t.success?(e=c(n.$trigger.data("entry-id")))&&setTimeout(function(){e.replace(t.content)},300):i.log.error(null,!0)}).catch(function(t){i.log.error(t,!0)})},deleteEntry:function(t){var e=c(t.$trigger.data("entry-id"));e?n.post(e.options.deleteUrl).then(function(t){o.global.close(),t.success&&setTimeout(function(){e.remove()},1e3)}).catch(function(t){i.log.error(t,!0)}):i.log.error(null,!0)}})});