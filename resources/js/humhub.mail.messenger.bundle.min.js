humhub.module("mail.ConversationView",function(r,t,a){var e=t("ui.widget").Widget,i=t("ui.loader"),s=t("client"),o=t("ui.additions"),l=t("util.object"),n=t("mail.notification"),c=e.extend();c.prototype.init=function(){o.observe(this.$);var e=this;window.onresize=function(t){e.updateSize()},this.reload(),this.$.on("mouseenter",".mail-conversation-entry",function(){a(this).find(".conversation-menu").fadeIn("fast")}).on("mouseleave",".mail-conversation-entry",function(){a(this).find(".conversation-menu").hide()})},c.prototype.loader=function(t){!1!==t?i.set(this.$):i.reset(this.$)},c.prototype.markSeen=function(t){s.post(r.config.url.seen,{data:{id:t}}).then(function(t){l.isDefined(t.messageCount)&&n.setMailMessageCount(t.messageCount)}).catch(function(t){r.log.error(t)})},c.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:last").data("entry-id"),e={id:this.options.messageId,from:t},i=this;s.get(this.options.loadUpdateUrl,{data:e}).then(function(t){t.html&&i.appendEntry(t.html)})},c.prototype.reply=function(t){var e=this;s.submit(t).then(function(t){t.success?(e.appendEntry(t.content),e.$.find(".time").timeago(),a("#replyform-message").trigger("clear")):r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},c.prototype.updateContent=function(t){this.$.hide().html(t).fadeIn(),this.getListNode().niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}});var e=this;setTimeout(function(){e.scrollToBottom()})},c.prototype.reload=function(){this.options.messageId&&this.loadMessage(this.options.messageId)},c.prototype.addUser=function(t){var e=this;e.loader(!0),s.submit(t).then(function(t){t.error?(r.log.error(t,!0),e.reload()):e.updateContent(t.html)}).catch(function(t){r.log.error(t,!0)}).finally(function(){e.loader(!1)})},c.prototype.appendEntry=function(t){var e=this,i=a(t),o=i.not("script, link").filter(function(){return 1===this.nodeType});o.css("opacity",0),this.getListNode().append(i),o.hide().css("opacity",1).fadeIn("fast",function(){e.scrollToBottom(),e.onUpdate()})},c.prototype.loadMessage=function(i){var o=l.isNumber(i)?i:i.$trigger.data("message-id"),n=this;this.loader(),s.get(this.options.loadMessageUrl,{data:{id:o}}).then(function(t){var e;n.options.messageId=o,a("#mail-conversation-overview").find(".selected[data-message-preview]").find(".new-message-badge").hide(),a("#mail-conversation-overview").find("[data-message-preview]").removeClass("selected"),a("#mail-conversation-overview").find('[data-message-preview="'+o+'"]').addClass("selected").find(".new-message-badge").hide(),i.$trigger&&history&&history.replaceState&&((e=i.$trigger.data("action-url"))&&history.replaceState(null,null,e)),n.updateContent(t.html)}).catch(function(t){r.log.error(t,!0)}).finally(function(){n.loader(!1)})},c.prototype.scrollToBottom=function(){var t=this.getListNode();t.animate({scrollTop:t[0].scrollHeight}),this.updateSize()},c.prototype.updateSize=function(){var i=this;setTimeout(function(){var t,e;a(".conversation-entry-list").length&&(t=a(".mail-message-form").height(),e=window.innerHeight-i.$.position().top-t-160+"px",i.$.find(".conversation-entry-list").css("max-height",e))},100)},c.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},c.prototype.onUpdate=function(){this.getListNode().getNiceScroll().resize()},r.export=c}),humhub.module("mail.ConversationEntry",function(t,e,o){var i=e("ui.widget").Widget.extend();i.prototype.replace=function(t){var e=this,i=o(t).hide();this.$.fadeOut(function(){o(this).replaceWith(i),e.$=i,e.$.fadeIn("slow")})},i.prototype.remove=function(){this.$.fadeToggle("slow",function(){o(this).remove()})},t.export=i}),humhub.module("mail.inbox",function(t,e,o){var i=e("ui.widget").Widget,n=e("ui.filter").Filter.extend();n.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},n.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),i=e.find(".filterCount");t?(i.length||(i=o('<small class="filterCount"></small>').insertBefore(e.find(".caret"))),i.html(" <b>("+t+")</b> ")):i.length&&i.remove()};var r=i.extend();r.prototype.init=function(){this.filter=i.instance("#mail-filter-root");var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",function(){t.reload()})},r.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}};t.export({ConversationList:r,Filter:n,setTagFilter:function(t){o("#mail-filter-menu").collapse("show"),i.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])}})}),humhub.module("mail.conversation",function(o,t,e){function n(){return i.instance("#mail-conversation-root")}var i=t("ui.widget").Widget,r=t("ui.modal"),a=t("client"),s=t("event"),l=t("mail.notification"),c=function(t){return i.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')},d=function(t){return e("#mail-conversation-overview").find('[data-message-preview="'+t+'"]')};o.export({init:function(){s.on("humhub:modules:mail:live:NewUserMessage",function(t,e,i){var o=n();e.forEach(function(t){o&&o.options.messageId==t.data.message_id?(o.loadUpdate(),o.markSeen(t.data.message_id)):o&&d(t.data.message_id).find(".new-message-badge").show(),l.setMailMessageCount(t.data.count)})}).on("humhub:modules:mail:live:UserMessageDeleted",function(t,e,i){e.forEach(function(t){var e=c(t.data.entry_id);e&&e.remove(),l.setMailMessageCount(t.data.count)})})},leave:function(t){a.post(t).then(function(t){t.redirect&&a.pjax.redirect(t.redirect)}).catch(function(t){o.log.error(t,!0)})},loadMessage:function(t){e("#mail-conversation-root").length?n().loadMessage(t):a.pjax.redirect(t.url),t.finish()},submitEditEntry:function(i){r.submit(i).then(function(t){var e;t.success?(e=c(i.$trigger.data("entry-id")))&&setTimeout(function(){e.replace(t.content)},300):o.log.error(null,!0)}).catch(function(t){o.log.error(t,!0)})},deleteEntry:function(t){var e=c(t.$trigger.data("entry-id"));e?a.post(e.options.deleteUrl).then(function(t){r.global.close(),t.success&&setTimeout(function(){e.remove()},1e3)}).catch(function(t){o.log.error(t,!0)}):o.log.error(null,!0)}})});